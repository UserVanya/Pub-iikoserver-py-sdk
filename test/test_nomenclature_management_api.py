# coding: utf-8

"""
    iikoServer API

    API Server позволяет сделать интеграции, которые предназначены для работы с номенклатурой, отчетами, документами, данными сотрудников и приказами.   ### Ограничения и рекомендации - Запросы должны выполняться последовательно друг за другом - Запрашивайте данные за период не длиннее одного месяца, в идеале — за один день или неделю - Для OLAPv2-отчетов рекомендуется устанавливать build-summary=false - При построении OLAPv2-отчета рекомендуется использовать не более 7 полей - Перед выполнением запросов проверяйте их на демо сервере

    The version of the OpenAPI document: 1.0.0
    Generated by OpenAPI Generator (https://openapi-generator.tech)

    Do not edit the class manually.
"""  # noqa: E501


import base64
from datetime import datetime, timedelta
import hashlib
import os
import re
import unittest

import requests

from iikoserver_client.api.nomenclature_management_api import NomenclatureManagementApi
from iikoserver_client.api.session_management_api import SessionManagementApi
from iikoserver_client.api_client import ApiClient
from iikoserver_client.configuration import Configuration
from iikoserver_client.models.base_assembly_chart_item_dto import BaseAssemblyChartItemDto
from iikoserver_client.models.base_entity_dto import BaseEntityDto
from iikoserver_client.models.base_product_size_dto import BaseProductSizeDto
from iikoserver_client.models.entity_update_dto import EntityUpdateDto
from iikoserver_client.models.id_list_dto import IdListDto
from iikoserver_client.models.product_group_delete_restore_request_scheme import ProductGroupDeleteRestoreRequestScheme
from iikoserver_client.models.product_scale_save_dto import ProductScaleSaveDto
from iikoserver_client.models.product_group_save_dto import ProductGroupSaveDto
from iikoserver_client.models.product_group_update_dto import ProductGroupUpdateDto
from iikoserver_client.models.product_scale_update_dto import ProductScaleUpdateDto
from iikoserver_client.models.product_size_assembly_strategy import ProductSizeAssemblyStrategy
from iikoserver_client.models.product_size_dto import ProductSizeDto
from iikoserver_client.models.product_size_factor_dto import ProductSizeFactorDto
from iikoserver_client.models.product_size_set_scheme import ProductSizeSetScheme
from iikoserver_client.models.product_type import ProductType
from iikoserver_client.models.product_save_dto import ProductSaveDto
from iikoserver_client.models.id_codet_dto import IdCodetDto
from iikoserver_client.models.product_update_dto import ProductUpdateDto
from iikoserver_client.models.base_image_dto import BaseImageDto
from iikoserver_client.models.product_scale_set_scheme import ProductScaleSetScheme

import asyncio

from iikoserver_client.models.product_writeoff_strategy import ProductWriteoffStrategy
from iikoserver_client.models.request_result_dto_enum import RequestResultDtoEnum
from iikoserver_client.models.save_assembly_chart_dto import SaveAssemblyChartDto

class TestNomenclatureManagementApi(unittest.IsolatedAsyncioTestCase):
    """NomenclatureManagementApi unit test stubs"""

    async def asyncSetUp(self) -> None:
        # Read credentials from env variables or set them directly
        self.server_url = os.environ.get("IIKO_SERVER_URL", None)
        self.login = os.environ.get("IIKO_SERVER_LOGIN", None)  # Replace with your login
        self.password = os.environ.get("IIKO_SERVER_PASSWORD", None)  # Replace with your password
        self.password_hash = hashlib.sha1(self.password.encode()).hexdigest()
        
        # Create configuration
        self.config = Configuration(host=self.server_url, debug=True)
        
        # Create API client with context manager support
        self.client = ApiClient(configuration=self.config)
        self.session_api = SessionManagementApi(api_client=self.client)
        self.portion_unit_id = "6040d92d-e286-f4f9-a613-ed0e6fd241e1"
        self.test_group_id = "0ce43181-b9b9-449f-b5d9-58f6995f9f77"
        self.test_product_id = "24c5217e-fdeb-47b8-ba7a-f31e3d032f53"
        self.test_chart_id = "ae709795-08e4-4b51-b178-2875a923606c"
        self.test_department_id = "65430fca-3116-f1b6-0197-5488678d0011"
        self.test_scale_id = "65430fca-3116-f1b6-0197-96f68442ad29"
            
        await self.session_api.auth_post(login=self.login, var_pass=self.password_hash)
        self.api = NomenclatureManagementApi(api_client=self.client)

    async def asyncTearDown(self) -> None:
        # Make sure to properly close all connections
        try:
            await self.session_api.logout_post()
        except Exception as e:
            print(f"Warning: logout failed: {e}")
        
        # Ensure client is closed properly
        await self.client.close()
        
        # Give event loop time to cleanup resources
        await asyncio.sleep(0.1)

    async def test_v2_entities_products_list_get(self) -> None:
        """Test case for v2_entities_products_list_get

        Получение списка продуктов
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_products_list_get(include_deleted=False)
            print([product for product in response if "60/40" in product.name.lower()])
            #                                                        parent_ids=[self.test_group_id])
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products list GET test failed with error: {str(e)}")

    async def test_v2_entities_products_list_post(self) -> None:
        """Test case for v2_entities_products_list_post

        Получение списка продуктов
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_products_list_post(
                include_deleted=False,
                types=[ProductType.GOODS],
                parent_ids=[self.test_group_id]
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products list POST test failed with error: {str(e)}")

    async def test_v2_entities_products_save_post(self) -> None:
        """Test case for v2_entities_products_save_post

        Создание продукта
        """
        try:
            products = await self.api.v2_entities_products_list_post(
                include_deleted=False,
                parent_ids=[self.test_group_id]
            )
            product_numbers = [int(product.name.split("|")[-1]) for product in products]
            product_number = max(product_numbers) + 1 if product_numbers else 0
            response = await self.api.v2_entities_products_save_post(
                generate_nomenclature_code=True,
                generate_fast_code=True,
                product_save_dto=ProductSaveDto(
                    name=f"Test|Продукт для API|0|{product_number}",
                    description=f"Описание продукта|0|{product_number}",
                    type=ProductType.GOODS,
                    mainUnit=self.portion_unit_id,
                    parent=self.test_group_id
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
            self.assertEqual(response.result, RequestResultDtoEnum.SUCCESS)
        except Exception as e:
            self.fail(f"Products save POST test failed with error: {str(e)}")

    async def test_v2_entities_products_update_post(self) -> None:
        """Test case for v2_entities_products_update_post

            Обновление продукта
        """
        try:
            products = await self.api.v2_entities_products_list_post(
                include_deleted=False,
                parent_ids=[self.test_group_id]
            )
            # Product with max number after "|"
            product = max(products, key=lambda x: int(x.name.split("|")[-1]))
            # Call the API method
            product_number = product.name.split("|")[-1]
            update_number = int(product.name.split("|")[-2]) + 1
            response = await self.api.v2_entities_products_update_post(
                override_fast_code=True,
                override_nomenclature_code=True,
                product_update_dto=ProductUpdateDto(
                    id=product.id,
                    name=f"Test|Продукт для API|{update_number}|{product_number}",
                    description=f"Описание продукта|{update_number}|{product_number}",
                    type=ProductType.GOODS,
                    mainUnit=self.portion_unit_id,
                    parent=self.test_group_id
                )
            )
            self.assertEqual(response.result, RequestResultDtoEnum.SUCCESS)
        except Exception as e:
            self.fail(f"Products update POST test failed with error: {str(e)}")

    async def test_v2_entities_products_delete_post(self) -> None:
        """Test case for v2_entities_products_delete_post

        Удаление продукта
        """
        try:
            # Call the API method
            products = await self.api.v2_entities_products_list_post(
                include_deleted=False,
                parent_ids=[self.test_group_id]
            )
            # Product with max number after "|"
            product = max(products, key=lambda x: int(x.name.split("|")[-1]))
            response = await self.api.v2_entities_products_delete_post(
                id_list_dto=IdListDto(
                    items=[IdCodetDto(id=product.id)]
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products delete POST test failed with error: {str(e)}")

    async def test_v2_entities_products_restore_post(self) -> None:
        """Test case for v2_entities_products_restore_post

        Восстановление продукта
        """
        try:
            # Call the API method
            products = await self.api.v2_entities_products_list_post(
                include_deleted=True,
                parent_ids=[self.test_group_id]
            )
            # Product with max number after "|"
            product = max(products, key=lambda x: int(x.name.split("|")[-1]) if x.deleted else 0)
            response = await self.api.v2_entities_products_restore_post(
                override_nomenclature_code=True,
                id_list_dto=IdListDto(
                    items=[IdCodetDto(id=product.id)]
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
            self.assertEqual(response.result, RequestResultDtoEnum.SUCCESS)
        except Exception as e:
            self.fail(f"Products restore POST test failed with error: {str(e)}")

    async def test_v2_entities_products_group_list_get(self) -> None:
        """Test case for v2_entities_products_group_list_get

        Получение списка групп продуктов
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_products_group_list_get(
                include_deleted=False,
                ids=["3c2aa444-210d-4c2a-98df-89e1b57064d1"]
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products group list GET test failed with error: {str(e)}")

    async def test_v2_entities_products_group_list_post(self) -> None:
        """Test case for v2_entities_products_group_list_post

        Получение списка групп продуктов
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_products_group_list_post(
                include_deleted=False,
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products group list POST test failed with error: {str(e)}")

    async def test_v2_entities_products_group_save_post(self) -> None:
        """Test case for v2_entities_products_group_save_post

        Создание группы продуктов
        """
        try:
            # Call the API method
            product_groups = await self.api.v2_entities_products_group_list_post(
                include_deleted=False,
                parent_ids=[self.test_group_id]
            )
            product_group_numbers = [int(product_group.name.split("|")[-1]) for product_group in product_groups]
            product_group_number = max(product_group_numbers) + 1 if product_group_numbers else 0
            response = await self.api.v2_entities_products_group_save_post(
                generate_nomenclature_code=True,
                generate_fast_code=True,
                product_group_save_dto=ProductGroupSaveDto(
                    name=f"Test|Группа API|0|{product_group_number}",
                    description=f"Описание группы продуктов|0|{product_group_number}",
                    parent=self.test_group_id
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products group save POST test failed with error: {str(e)}")

    async def test_v2_entities_products_group_update_post(self) -> None:
        """Test case for v2_entities_products_group_update_post

        Обновление группы продуктов
        """
        try:
            # Call the API method
            product_groups = await self.api.v2_entities_products_group_list_post(
                include_deleted=False,
                parent_ids=[self.test_group_id]
            )
            product_group = max(product_groups, key=lambda x: int(x.name.split("|")[-1]))
            product_group_number = product_group.name.split("|")[-1]
            update_number = int(product_group.name.split("|")[-2]) + 1
            response = await self.api.v2_entities_products_group_update_post(
                override_nomenclature_code=True,
                override_fast_code=True,
                product_group_update_dto=ProductGroupUpdateDto(
                    id=product_group.id,
                    name=f"Test|Группа API|{update_number}|{product_group_number}",
                    description=f"Описание группы продуктов|{update_number}|{product_group_number}",
                    parent=self.test_group_id
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products group update POST test failed with error: {str(e)}")

    async def test_v2_entities_products_group_delete_post(self) -> None:
        """Test case for v2_entities_products_group_delete_post

        Удаление группы продуктов
        """
        try:
            # Call the API method
            product_groups = await self.api.v2_entities_products_group_list_post(
                include_deleted=False,
                parent_ids=[self.test_group_id]
            )
            product_group = max(product_groups, key=lambda x: int(x.name.split("|")[-1]))
            response = await self.api.v2_entities_products_group_delete_post(
                product_group_delete_restore_request_scheme=ProductGroupDeleteRestoreRequestScheme(
                    products=IdListDto(
                        items=[]
                    ),
                    productGroups=IdListDto(
                        items=[IdCodetDto(id=product_group.id)]
                    )
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products group delete POST test failed with error: {str(e)}")

    async def test_v2_entities_products_group_restore_post(self) -> None:
        """Test case for v2_entities_products_group_restore_post

        Восстановление группы продуктов
        """
        try:
            # Call the API method
            product_groups = await self.api.v2_entities_products_group_list_post(
                include_deleted=True,
                parent_ids=[self.test_group_id]
            )
            product_group = max(product_groups, key=lambda x: int(x.name.split("|")[-1]) if x.deleted else 0)
            response = await self.api.v2_entities_products_group_restore_post(
                product_group_delete_restore_request_scheme=ProductGroupDeleteRestoreRequestScheme(
                    products=IdListDto(
                        items=[]
                    ),
                    productGroups=IdListDto(
                        items=[IdCodetDto(id=product_group.id)]
                    )
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products group restore POST test failed with error: {str(e)}")

    async def test_v2_entities_products_category_list_get(self) -> None:
        """Test case for v2_entities_products_category_list_get

        Получение списка категорий продуктов
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_products_category_list_get(
                include_deleted=False
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products category list GET test failed with error: {str(e)}")

    async def test_v2_entities_products_category_list_post(self) -> None:
        """Test case for v2_entities_products_category_list_post

        Получение списка категорий продуктов
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_products_category_list_post(
                include_deleted=True
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products category list POST test failed with error: {str(e)}")

    async def test_v2_entities_products_category_save_post(self) -> None:
        """Test case for v2_entities_products_category_save_post

        Создание категории продуктов
        """
        try:
            # Call the API method
            categories = await self.api.v2_entities_products_category_list_post(
                include_deleted=True
            )
            category_numbers = [int(category.name.split("|")[-1]) if "|" in category.name else -1 for category in categories]
            category_number = max(category_numbers) + 1 if category_numbers else 0
            response = await self.api.v2_entities_products_category_save_post(
                base_entity_dto=BaseEntityDto(
                    name=f"Test|Категория API|0|{category_number}"
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products category save POST test failed with error: {str(e)}")

    async def test_v2_entities_products_category_update_post(self) -> None:
        """Test case for v2_entities_products_category_update_post

        Обновление категории продуктов
        """
        try:
            # Call the API method
            categories = await self.api.v2_entities_products_category_list_post(
                include_deleted=True
            )
            category = max(categories, key=lambda x: int(x.name.split("|")[-1]) if "|" in x.name else -1)
            category_number = category.name.split("|")[-1]
            update_number = int(category.name.split("|")[-2]) + 1
            response = await self.api.v2_entities_products_category_update_post(
                entity_update_dto=EntityUpdateDto(
                    id=category.id,
                    name=f"Test|Категория API|{update_number}|{category_number}"
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products category update POST test failed with error: {str(e)}")

    async def test_v2_entities_products_category_delete_post(self) -> None:
        """Test case for v2_entities_products_category_delete_post

        Удаление категории продуктов
        """
        try:
            # Call the API method
            categories = await self.api.v2_entities_products_category_list_post(
                include_deleted=False
            )
            category = max(categories, key=lambda x: int(x.name.split("|")[-1]) if "|" in x.name else -1)
            response = await self.api.v2_entities_products_category_delete_post(
                id_codet_dto=IdCodetDto(id=category.id)
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products category delete POST test failed with error: {str(e)}")

    async def test_v2_entities_products_category_restore_post(self) -> None:
        """Test case for v2_entities_products_category_restore_post

        Восстановление категории продуктов
        """
        try:
            # Call the API method
            categories = await self.api.v2_entities_products_category_list_post(
                include_deleted=True
            )
            category = max(categories, key=lambda x: int(x.name.split("|")[-1]) if "|" in x.name else -1)
            response = await self.api.v2_entities_products_category_restore_post(
                id_codet_dto=IdCodetDto(id=category.id)
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products category restore POST test failed with error: {str(e)}")

    async def test_v2_assembly_charts_get_all_get(self) -> None:
        """Test case for v2_assembly_charts_get_all_get

        Получение всех технологических карт
        """
        try:
            # Call the API method
            response = await self.api.v2_assembly_charts_get_all_get(
                date_from=datetime(2025, 6, 24).date(),
                date_to=datetime(2025, 6, 26).date()
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Assembly charts GET all GET test failed with error: {str(e)}")

    async def test_v2_assembly_charts_get_all_update_get(self) -> None:
        """Test case for v2_assembly_charts_get_all_update_get

        Получение всех технологических карт
        """
        try:
            # Call the API method
            response = await self.api.v2_assembly_charts_get_all_update_get(
                known_revision=-1,
                date_from=datetime(2025, 6, 24).date(),
                date_to=datetime(2025, 6, 26).date(),
                include_deleted_products=False,
                include_prepared_charts=False
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Assembly charts GET all update GET test failed with error: {str(e)}")

    async def test_v2_assembly_charts_get_tree_get(self) -> None:
        """Test case for v2_assembly_charts_get_tree_get

        Получение дерева технологических карт
        """
        try:
            # Call the API method
            response = await self.api.v2_assembly_charts_get_tree_get(
                var_date=datetime(2025, 6, 25).date(),
                product_id=self.test_product_id,
            #    department_id=self.test_department_id
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Assembly charts GET tree GET test failed with error: {str(e)}")

    async def test_v2_assembly_charts_get_assembled_get(self) -> None:
        """Test case for v2_assembly_charts_get_assembled_get

        Получение исходной технологической карты для элемента номенклатуры
        """
        try:
            # Call the API method
            response = await self.api.v2_assembly_charts_get_assembled_get(
                var_date=datetime(2025, 6, 25).date(),
                product_id=self.test_product_id,
            #    department_id=self.test_department_id
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Assembly charts GET assembled GET test failed with error: {str(e)}")

    async def test_v2_assembly_charts_get_prepared_get(self) -> None:
        """Test case for v2_assembly_charts_get_prepared_get

        Получение технологических карт, готовых к сборке
        """
        try:
            # Call the API method
            response = await self.api.v2_assembly_charts_get_prepared_get(
                var_date=datetime(2025, 6, 25).date(),
                product_id=self.test_product_id,
#                department_id=self.test_department_id
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Assembly charts GET prepared GET test failed with error: {str(e)}")

    async def test_v2_assembly_charts_get_by_id_get(self) -> None:
        """Test case for v2_assembly_charts_get_by_id_get

        Получение технологической карты по id
        """
        try:
            # Call the API method
            response = await self.api.v2_assembly_charts_by_id_get(
                id=self.test_chart_id
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Assembly charts GET by id GET test failed with error: {str(e)}")

    async def test_v2_assembly_charts_get_history_get(self) -> None:
        """Test case for v2_assembly_charts_get_history_get

        Получение истории технологических карт
        """
        try:
            # Call the API method
            response = await self.api.v2_assembly_charts_get_history_get(
                product_id=self.test_product_id,
            #    department_id=self.test_department_id
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Assembly charts GET history GET test failed with error: {str(e)}")

    async def test_v2_assembly_charts_save_post(self) -> None:
        """Test case for v2_assembly_charts_save_post

        Создание технологической карты
        """
        try:
            #Create product in test group named "Test|Капучино API|{number}"
            dishes = await self.api.v2_entities_products_list_get(
                include_deleted=True,
                types=[ProductType.DISH],
                parent_ids=[self.test_group_id]
            )
            goods = await self.api.v2_entities_products_list_get(
                include_deleted=True,
                types=[ProductType.GOODS]
            )
            milk = next((p for p in goods if p.name == "Молоко"), None)
            coffee = next((p for p in goods if p.name == "Кофе"), None)
            cappucino_dishes = [p for p in dishes if p.name.startswith("Test|Капучино API")]
            dish_number = int(max(cappucino_dishes, key=lambda x: int(x.name.split("|")[-1]) if "|" in x.name else -1).name.split("|")[-1]) + 1 if cappucino_dishes else 0
            create_product_result = await self.api.v2_entities_products_save_post(
                generate_nomenclature_code=True,
                generate_fast_code=True,
                product_save_dto=ProductSaveDto(
                    id=self.test_group_id,
                    name=f"Test|Капучино API|{dish_number}",
                    description=f"Для тестирования создания технологической карты",
                    parent=self.test_group_id,
                    mainUnit=self.portion_unit_id,
                    type=ProductType.DISH,
                    unitWeight=0.175
                )
            )
            product_id = create_product_result.response.id
            print(product_id)
            # Create assembly chart in test group named "Test|Капучино API|0|{number}"
            assembly_chart_create_result = await self.api.v2_assembly_charts_save_post(
                save_assembly_chart_dto=SaveAssemblyChartDto(
                    assembledProductId=product_id,
                    dateFrom=datetime(2025, 5, 18).date(),
                    assembledAmount=1,
                    productWriteoffStrategy=ProductWriteoffStrategy.DIRECT,
                    productSizeAssemblyStrategy=ProductSizeAssemblyStrategy.COMMON,
                    items=[
                        BaseAssemblyChartItemDto(
                            productId=milk.id, 
                            amountIn=0.120, 
                            amountOut=0.120, 
                            amountMiddle=0.120,
                            amountIn1=0,
                            amountOut1=0,
                            amountIn2=0,
                            amountOut2=0,
                            amountIn3=0,
                            amountOut3=0,
                            sortWeight=0
                            ),
                        BaseAssemblyChartItemDto(
                            productId=coffee.id, 
                            amountIn=0.009, 
                            amountOut=0.009, 
                            amountMiddle=0.009,
                            amountIn1=0,
                            amountOut1=0,
                            amountIn2=0,
                            amountOut2=0,
                            amountIn3=0,
                            amountOut3=0,
                            sortWeight=1
                        )
                    ],
                    technologyDescription="Технология сборки",
                    description="Описание технологической карты",
                    appearance="Описание внешнего вида",
                    organoleptic="Описание органолептических свойств",
                    outputComment="Комментарий к выходу"
                )
            )
            self.assertIsNotNone(assembly_chart_create_result.response)
        except Exception as e:
            self.fail(f"Assembly charts save POST test failed with error: {str(e)}")

    async def test_v2_assembly_charts_delete_post(self) -> None:
        """Test case for v2_assembly_charts_delete_post

        Удаление технологической карты
        """
        try:
            dishes = await self.api.v2_entities_products_list_get(
                include_deleted=True,
                types=[ProductType.DISH],
                parent_ids=[self.test_group_id]
            )
            cappucino_dishes = [p for p in dishes if p.name.startswith("Test|Капучино API")]
            self.assertGreater(len(cappucino_dishes), 0)
            cappucino_max = max(cappucino_dishes, key=lambda x: int(x.name.split("|")[-1]))
            #obtain all charts for cappucino_max
            cappucino_charts = await self.api.v2_assembly_charts_get_history_get(
                product_id=cappucino_max.id
            )
            self.assertEqual(len(cappucino_charts), 1)
            # Call the API method
            response = await self.api.v2_assembly_charts_delete_post(
                id_codet_dto=IdCodetDto(id=cappucino_charts[0].id)
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Assembly charts delete POST test failed with error: {str(e)}")

    async def test_v2_images_load_get(self) -> None:
        """Test case for v2_images_load_get

        Загрузка изображения
        """
        try:
            # Call the API method
            product = await self.api.v2_entities_products_list_get(
                include_deleted=True,
                ids=[self.test_product_id]
            )
            self.assertEqual(len(product), 1)
            response = await self.api.v2_images_load_get(
                image_id=product[0].front_image_id
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Images load GET test failed with error: {str(e)}")

    async def test_v2_images_save_post(self) -> None:
        """Test case for v2_images_save_post

        Сохранение изображения
        """
        try:
            # Call the API method
            # load random image from internet
            
            product = await self.api.v2_entities_products_list_get(
                include_deleted=True,
                ids=[self.test_product_id]
            )
            self.assertEqual(len(product), 1)
            image_load_response = await self.api.v2_images_load_get(
                image_id=product[0].front_image_id
            )
            response = await self.api.v2_images_save_post(
                base_image_dto=BaseImageDto(
                    data=image_load_response.response.data
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Images save POST test failed with error: {str(e)}")
    
    async def test_v2_images_delete_post(self) -> None:
        """Test case for v2_images_delete_post

        Удаление изображения
        """
        try:
            # Call the API method
            # load random image from internet
            
            product = await self.api.v2_entities_products_list_get(
                include_deleted=True,
                ids=[self.test_product_id]
            )
            self.assertEqual(len(product), 1)
            image_load_response = await self.api.v2_images_load_get(
                image_id=product[0].front_image_id
            )
            response_save = await self.api.v2_images_save_post(
                base_image_dto=BaseImageDto(
                    data=image_load_response.response.data
                )
            )
            image_id = response_save.response.id
            response_delete = await self.api.v2_images_delete_post(
                id_list_dto=IdListDto(items=[IdCodetDto(id=image_id)])
            )
            # Add assertions
            self.assertIsNotNone(response_delete)
        except Exception as e:
            self.fail(f"Images delete POST test failed with error: {str(e)}")

    async def test_v2_product_scales_list_get(self) -> None:
        """Test case for v2_product_scales_list_get

        Получение списка шкал размеров
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_product_scales_get(
                include_deleted=True
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Product scales list GET test failed with error: {str(e)}")

    async def test_v2_entities_product_scales_list_post(self) -> None:
        """Test case for v2_entities_product_scales_list_post

        Получение шкалы размеров
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_product_scales_post(
                include_deleted=True
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Product scales list POST test failed with error: {str(e)}")

    async def test_v2_entities_product_scales_by_id_get(self) -> None:
        """Test case for v2_entities_product_scales_by_id_get

        Получение шкалы размеров по id
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_product_scales_product_scale_id_get(
                product_scale_id=self.test_scale_id
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Product scales by id GET test failed with error: {str(e)}")

    async def test_v2_entities_product_scales_save_post(self) -> None:
        """Test case for v2_entities_product_scales_save_post

        Создание шкалы размеров
        """
        try:
            # Call the API method
            scales = await self.api.v2_entities_product_scales_get(
                include_deleted=True
            )
            test_scales = [s for s in scales if "Test|Шкала API|" in s.name]
            scale_number = int(max(test_scales, key=lambda x: int(x.name.split("|")[-1])).name.split("|")[-1]) + 1 if len(test_scales) > 0 else 0
            response = await self.api.v2_entities_product_scales_save_post(
                product_scale_save_dto=ProductScaleSaveDto(
                    name=f"Test|Шкала API|0|{scale_number}",
                    productSizes=[
                        BaseProductSizeDto(
                            name=f"Test|Размер 1 API|0|{scale_number}",
                            shortName=f"Test|Размер 1 API|0|{scale_number}",
                            priority=0,
                            default=False
                        ),
                        BaseProductSizeDto(
                            name=f"Test|Размер 2 API|0|{scale_number}",
                            shortName=f"Test|Размер 2 API|0|{scale_number}",
                            priority=1,
                            default=False
                        )
                    ]
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Product scales save POST test failed with error: {str(e)}")

    async def test_v2_entities_product_scales_update_post(self) -> None:
        """Test case for v2_entities_product_scales_update_post

        Обновление шкалы размеров
        """
        try:
            # Call the API method
            scales = await self.api.v2_entities_product_scales_get(
                include_deleted=True
            )
            test_scales = [s for s in scales if "Test|Шкала API|" in s.name]
            self.assertGreater(len(test_scales), 0)
            test_scale = max(test_scales, key=lambda x: int(x.name.split("|")[-1]))
            update_number = int(test_scale.name.split("|")[-2]) + 1
            response = await self.api.v2_entities_product_scales_update_post(
                product_scale_update_dto=ProductScaleUpdateDto(
                    id=test_scale.id,
                    name=f"Test|Шкала API|{update_number}|{test_scale.name.split('|')[-1]}",
                    productSizes=[
                        ProductSizeDto(
                            id=test_scale.product_sizes[0].id,
                            name=f"Test|Размер 1 API|{update_number}|{test_scale.name.split('|')[-1]}",
                            shortName=f"Test|Размер 1 API|{update_number}|{test_scale.name.split('|')[-1]}",
                            priority=0,
                            default=False
                        ),
                        ProductSizeDto(
                            id=test_scale.product_sizes[1].id,
                            name=f"Test|Размер 2 API|{update_number}|{test_scale.name.split('|')[-1]}",
                            shortName=f"Test|Размер 2 API|{update_number}|{test_scale.name.split('|')[-1]}",
                            priority=1,
                            default=False
                        )
                    ]
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Product scales update POST test failed with error: {str(e)}")

    async def test_v2_entities_product_scales_delete_post(self) -> None:
        """Test case for v2_entities_product_scales_delete_post

        Удаление шкалы размеров
        """
        try:
            scales = await self.api.v2_entities_product_scales_get(
                include_deleted=True
            )
            test_scales = [s for s in scales if "Test|Шкала API|" in s.name]
            self.assertGreater(len(test_scales), 0)
            test_scale = max(test_scales, key=lambda x: int(x.name.split("|")[-1]))
            # Call the API method
            response = await self.api.v2_entities_product_scales_delete_post(
                id_list_dto=IdListDto(items=[IdCodetDto(id=test_scale.id)])
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Product scales delete POST test failed with error: {str(e)}")

    async def test_v2_entities_product_scales_restore_post(self) -> None:
        """Test case for v2_entities_product_scales_restore_post

        Восстановление шкалы размеров
        """
        try:
            scales = await self.api.v2_entities_product_scales_get(
                include_deleted=True
            )
            test_scales = [s for s in scales if "Test|Шкала API|" in s.name]
            self.assertGreater(len(test_scales), 0)
            test_scale = max(test_scales, key=lambda x: int(x.name.split("|")[-1]))
            # Call the API method
            response = await self.api.v2_entities_product_scales_restore_post(
                id_list_dto=IdListDto(items=[IdCodetDto(id=test_scale.id)])
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Product scales restore POST test failed with error: {str(e)}")
    
    async def test_v2_entities_products_product_scales_get(self) -> None:

        """Test case for v2_entities_product_scales_get_product_scales_for_products_get

        Получение шкал размеров для продуктов
        """
        try:
            # Obtain product with name Капучино по размерам
            products = await self.api.v2_entities_products_list_get(
                include_deleted=False,
                types=[ProductType.DISH]
            )
            capuchino = [p for p in products if p.name == "Капучино по размерам"]
            self.assertEqual(len(capuchino), 1)
            capuchino = capuchino[0]
            # Call the API method
            response1 = await self.api.v2_entities_products_product_scales_get(
                product_id=[capuchino.id],
                include_deleted_products=False
            )
            print(response1)

            # obtain product scales for almond_coffee
            # Add assertions
            self.assertIsNotNone(response1)
            response2 = await self.api.v2_entities_products_product_scales_get(
                include_deleted_products=False,
                product_id=[self.test_product_id]
            )
            print(response2)
            self.assertIsNotNone(response2)
        except Exception as e:
            self.fail(f"Product scales for products GET test failed with error: {str(e)}")

    async def test_v2_entities_products_product_scales_post(self) -> None:
        """Test case for v2_entities_products_product_scales_post

        Получение шкал размеров для продуктов
        """
        try:
            # Obtain product with name Капучино по размерам
            products = await self.api.v2_entities_products_list_get(
                include_deleted=False,
                types=[ProductType.DISH]
            )
            capuchino = [p for p in products if p.name == "Капучино по размерам"]
            self.assertEqual(len(capuchino), 1)
            capuchino = capuchino[0]
            # Call the API method
            response1 = await self.api.v2_entities_products_product_scales_post(
                product_id=[capuchino.id],
                include_deleted_products=False
            )
            print(response1)

            # obtain product scales for almond_coffee
            # Add assertions
            self.assertIsNotNone(response1)
            response2 = await self.api.v2_entities_products_product_scales_post(
                include_deleted_products=False,
                product_id=[self.test_product_id]
            )
            print(response2)
            self.assertIsNotNone(response2)
        except Exception as e:
            self.fail(f"Product scales for products POST test failed with error: {str(e)}")
            
    async def test_v2_entities_products_product_id_product_scale_post(self) -> None:
        """Test case for v2_entities_products_product_id_product_scale_post

        Создание шкалы размеров для продукта
        """
        try:
            #Нужно забрать последнюю созданную не удаленную шкалу размеров и засетить ее на последний созданный продукт типа DISH
            scales = await self.api.v2_entities_product_scales_get(
                include_deleted=True
            )
            test_scales = [s for s in scales if "Test|Шкала API|" in s.name and s.deleted is False]
            self.assertGreater(len(test_scales), 0)
            test_scale = max(test_scales, key=lambda x: int(x.name.split("|")[-1]))
            print(test_scale)
            products = await self.api.v2_entities_products_list_get(
                include_deleted=True,
                types=[ProductType.DISH],
                parent_ids=[self.test_group_id]
            )
            test_products = [p for p in products if "Test|Капучино API|" in p.name and p.deleted is False]
            self.assertGreater(len(test_products), 0)
            test_product = max(test_products, key=lambda x: int(x.name.split("|")[-1]))
            response = await self.api.v2_entities_products_product_id_product_scale_post(
                product_id=test_product.id,
                product_scale_set_scheme=ProductScaleSetScheme( 
                    id=test_scale.id,
                    product_sizes=[
                        ProductSizeSetScheme(
                            id=test_scale.product_sizes[0].id,
                            disabled=False,
                            factors=[
                                ProductSizeFactorDto(startNumber=0, factor=1.0)
                            ]
                        ),
                        ProductSizeSetScheme(
                            id=test_scale.product_sizes[1].id,
                            disabled=False,
                            factors=[
                                ProductSizeFactorDto(startNumber=0, factor=2.0)
                            ]
                        )
                    ]
                )
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Product scales for products POST test failed with error: {str(e)}")


    async def test_v2_entities_products_product_id_product_scale_delete(self) -> None:
        """Test case for v2_entities_products_product_id_product_scale_delete

        Удаление шкалы размеров для продукта
        """
        try:
            #get last product with name Test|Капучино API| and not none scale, if no products, raise fall
            products = await self.api.v2_entities_products_list_get(
                include_deleted=True,
                types=[ProductType.DISH],
                parent_ids=[self.test_group_id]
            )
            test_products = [p for p in products if "Test|Капучино API|" in p.name and p.deleted is False and p.product_scale_id is not None]
            self.assertGreater(len(test_products), 0)
            test_product = max(test_products, key=lambda x: int(x.name.split("|")[-1]))
            response = await self.api.v2_entities_products_product_id_product_scale_delete(
                product_id=test_product.id
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Product scales for products DELETE test failed with error: {str(e)}")

    async def test_products_get(self) -> None:
        """Test case for products_get

        Получение списка продуктов в XML формате
        """
        try:
            # Call the API method
            response = await self.api.products_get(
                revision_from=-1,
                include_deleted=False
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products GET test failed with error: {str(e)}")

    async def test_products_search_get(self) -> None:
        """Test case for products_search_get

        Поиск продуктов по номеру, артикулу, коду, типу, категории, родительской группе
        """
        try:
            # Call the API method
            #Все, что начинаются с "Миндальный кофе"
            regex_almond_coffee = r"^Миндальный кофе"
            response = await self.api.products_search_get(
                include_deleted=False,
                name=regex_almond_coffee
            )
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Products search GET test failed with error: {str(e)}")

if __name__ == '__main__':
    unittest.main()
