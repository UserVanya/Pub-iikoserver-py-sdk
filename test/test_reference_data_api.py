# coding: utf-8

"""
    iikoServer API

    API Server позволяет сделать интеграции, которые предназначены для работы с номенклатурой, отчетами, документами, данными сотрудников и приказами.   ### Ограничения и рекомендации - Запросы должны выполняться последовательно друг за другом - Запрашивайте данные за период не длиннее одного месяца, в идеале — за один день или неделю - Для OLAPv2-отчетов рекомендуется устанавливать build-summary=false - При построении OLAPv2-отчета рекомендуется использовать не более 7 полей - Перед выполнением запросов проверяйте их на демо сервере

    The version of the OpenAPI document: 1.0.0
    Generated by OpenAPI Generator (https://openapi-generator.tech)

    Do not edit the class manually.
"""  # noqa: E501


import hashlib
import os
import unittest
import asyncio

from iikoserver_client.api.reference_data_api import ReferenceDataApi
from iikoserver_client.api.session_management_api import SessionManagementApi
from iikoserver_client.api_client import ApiClient
from iikoserver_client.configuration import Configuration
from iikoserver_client.api.reference_data_api import ReferenceDataApi
from iikoserver_client.models.root_type_enum import RootTypeEnum

import logging

logging.basicConfig(level=logging.INFO)
logging.getLogger("iikoserver_client.http_logger").setLevel(logging.INFO)

class TestReferenceDataApi(unittest.IsolatedAsyncioTestCase):
    """ReferenceDataApi unit test stubs"""

    async def asyncSetUp(self) -> None:
        # Read credentials from env variables or set them directly
        self.server_url = os.environ.get("IIKO_SERVER_URL", None)
        self.login = os.environ.get("IIKO_SERVER_LOGIN", None)  # Replace with your login
        self.password = os.environ.get("IIKO_SERVER_PASSWORD", None)  # Replace with your password
        self.password_hash = hashlib.sha1(self.password.encode()).hexdigest()
        
        # Create configuration
        self.config = Configuration(host=self.server_url, debug=True)
        
        # Create API client with context manager support
        self.client = ApiClient(configuration=self.config)
        self.session_api = SessionManagementApi(api_client=self.client)
        await self.session_api.auth_post(login=self.login, var_pass=self.password_hash)
        self.api = ReferenceDataApi(api_client=self.client)

    async def asyncTearDown(self) -> None:
        # Make sure to properly close all connections
        try:
            await self.session_api.logout_post()
        except Exception as e:
            print(f"Warning: logout failed: {e}")
        
        # Ensure client is closed properly
        await self.client.close()
        
        # Give event loop time to cleanup resources
        await asyncio.sleep(0.1)

    async def test_v2_entities_list_get(self) -> None:
        """Test case for v2_entities_list_get

        Получение справочной информации
        """
        try:
            # Call the API method
            response = await self.api.v2_entities_list_get(root_type=RootTypeEnum.ACCOUNT)
            # Add assertions
            self.assertIsNotNone(response)
        except Exception as e:
            self.fail(f"Entities list GET test failed with error: {str(e)}")


if __name__ == '__main__':
    unittest.main()
