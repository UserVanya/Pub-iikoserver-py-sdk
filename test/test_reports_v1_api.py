# coding: utf-8

"""
    iikoServer API

    API Server позволяет сделать интеграции, которые предназначены для работы с номенклатурой, отчетами, документами, данными сотрудников и приказами.   ### Ограничения и рекомендации - Запросы должны выполняться последовательно друг за другом - Запрашивайте данные за период не длиннее одного месяца, в идеале — за один день или неделю - Для OLAPv2-отчетов рекомендуется устанавливать build-summary=false - При построении OLAPv2-отчета рекомендуется использовать не более 7 полей - Перед выполнением запросов проверяйте их на демо сервере

    The version of the OpenAPI document: 1.0.0
    Generated by OpenAPI Generator (https://openapi-generator.tech)

    Do not edit the class manually.
"""  # noqa: E501


from datetime import datetime, timedelta
import unittest
import os
import hashlib
import asyncio

from iikoserver_client.api.session_management_api import SessionManagementApi
from iikoserver_client.api.corporation_management_api import CorporationManagementApi
from iikoserver_client import ApiClient
from iikoserver_client.configuration import Configuration
from iikoserver_client.api.reports_v1_api import ReportsV1Api
from iikoserver_client.models.metric_type_enum import MetricTypeEnum
from iikoserver_client.models.olap_report_type_enum import OlapReportTypeEnum

class TestReportsV1Api(unittest.IsolatedAsyncioTestCase):
    """ReportsV1Api unit test stubs"""

    async def asyncSetUp(self) -> None:
        # Read credentials from env variables or set them directly
        self.server_url = os.environ.get("IIKO_SERVER_URL", None)
        self.login = os.environ.get("IIKO_SERVER_LOGIN", None)  # Replace with your login
        self.password = os.environ.get("IIKO_SERVER_PASSWORD", None)  # Replace with your password
        
        if not all([self.server_url, self.login, self.password]):
            self.skipTest("Missing environment variables: IIKO_SERVER_URL, IIKO_SERVER_LOGIN, IIKO_SERVER_PASSWORD")
        
        self.password_hash = hashlib.sha1(self.password.encode()).hexdigest()
        
        # Create configuration
        self.config = Configuration(host=self.server_url, debug=True)
        
        # Create API client with context manager support
        self.client = ApiClient(configuration=self.config)
        
        # Test data IDs - these should be updated with actual IDs from your test environment
        self.test_department_id = "a99e7f0c-0f19-467d-b845-f7052c81c7ed"
        self.test_coffee_product_id = "759787d1-f3dd-44cb-bbd8-6f70a7069579"
        self.test_store_id = "1239d270-1bbe-f64f-b7ea-5f00518ef508"
        self.test_product_id = "244079d3-3fa1-4479-96ef-e8183ed96de9"
        
        self.session_api = SessionManagementApi(api_client=self.client)
        self.corporation_api = CorporationManagementApi(api_client=self.client)
        await self.session_api.auth_post(login=self.login, var_pass=self.password_hash)
        self.api = ReportsV1Api(api_client=self.client)

    async def asyncTearDown(self) -> None:
        # Make sure to properly close all connections
        try:
            await self.session_api.logout_post()
        except Exception as e:
            print(f"Warning: logout failed: {e}")
        
        # Ensure client is closed properly
        await self.client.close()
        
        # Give event loop time to cleanup resources
        await asyncio.sleep(0.1)

    async def test_reports_store_operations_get(self) -> None:
        """Test case for reports_store_operations_get

        Отчет по складским операциям
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing store operations report from {date_from_str} to {date_to_str}")
            
            # Call the API with basic parameters
            result = await self.api.reports_store_operations_get(
                date_from=date_from_str,
                date_to=date_to_str,
                product_detalization=False,
                show_cost_corrections=True
            )
            
            print(f"Store operations report result type: {type(result)}")
            self.assertIsNotNone(result)
        except Exception as e:
            self.fail(f"Reports store operations GET failed with error: {str(e)}")

    async def test_reports_store_report_presets_get(self) -> None:
        """Test case for reports_store_report_presets_get

        Пресеты отчетов по складским операциям
        """
        try:
            print("Testing store report presets")
            
            # Call the API to get presets
            result = await self.api.reports_store_report_presets_get()
            
            print(f"Store report presets result type: {type(result)}")
            self.assertIsNotNone(result)
            
        except Exception as e:
            self.fail(f"Reports store report presets GET failed with error: {str(e)}")

    async def test_reports_product_expense_get(self) -> None:
        """Test case for reports_product_expense_get

        Расход продуктов по продажам
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing product expense report from {date_from_str} to {date_to_str}")
            
            # Call the API with required parameters
            result = await self.api.reports_product_expense_get(
                department=self.test_department_id,
                date_from=date_from_str,
                date_to=date_to_str
            )
            
            print(f"Product expense report result type: {type(result)}")
            self.assertIsNotNone(result)
        except Exception as e:
            self.fail(f"Reports product expense GET failed with error: {str(e)}")

    async def test_reports_sales_get(self) -> None:
        """Test case for reports_sales_get

        Отчет по выручке
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing sales report from {date_from_str} to {date_to_str}")
            
            # Test with detailed options
            result_detailed = await self.api.reports_sales_get(
                department=self.test_department_id,
                date_from=date_from_str,
                date_to=date_to_str,
                hour_from=10,
                hour_to=18,
                dish_details=True,
                all_revenue=False
            )
            
            print(f"Detailed sales report result type: {type(result_detailed)}")
            self.assertIsNotNone(result_detailed)
            
        except Exception as e:
            self.fail(f"Reports sales GET failed with error: {str(e)}")

    async def test_reports_monthly_income_plan_get(self) -> None:
        """Test case for reports_monthly_income_plan_get

        План по выручке за день
        """
        try:
            # Calculate date range (last week)
            
            date_from = datetime.now()
            date_to = date_from  + timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing monthly income plan from {date_from_str} to {date_to_str}")
            
            # Call the API
            result = await self.api.reports_monthly_income_plan_get(
                department=self.test_department_id,
                date_from=date_from_str,
                date_to=date_to_str
            )
            
            print(f"Monthly income plan result type: {type(result)}")
            self.assertIsNotNone(result)
            
        except Exception as e:
            self.fail(f"Reports monthly income plan GET failed with error: {str(e)}")

    async def test_reports_ingredient_entry_get(self) -> None:
        """Test case for reports_ingredient_entry_get

        Отчет о вхождении товара в блюдо
        """
        try:
            # Use current date
            date_str = datetime.now().strftime("%d.%m.%Y")
            
            # Test with subtree inclusion
            result_with_subtree = await self.api.reports_ingredient_entry_get(
                department=self.test_department_id,
                var_date=date_str,
                product=self.test_coffee_product_id,
                include_subtree=True
            )
            
            print(f"Ingredient entry report with subtree result type: {type(result_with_subtree)}")
            self.assertIsNotNone(result_with_subtree)
            
            
        except Exception as e:
            self.fail(f"Reports ingredient entry GET failed with error: {str(e)}")

    async def test_reports_delivery_consolidated_get(self) -> None:
        """Test case for reports_delivery_consolidated_get

        Сводный отчет по доставке
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing delivery consolidated report from {date_from_str} to {date_to_str}")
            
            # Call the API with basic parameters
            result = await self.api.reports_delivery_consolidated_get(
                date_from=date_from_str,
                date_to=date_to_str
            )
            
            print(f"Delivery consolidated report result type: {type(result)}")
            self.assertIsNotNone(result)
            
        except Exception as e:
            self.fail(f"Reports delivery consolidated GET failed with error: {str(e)}")

    async def test_reports_delivery_couriers_get(self) -> None:
        """Test case for reports_delivery_couriers_get

        Отчет по курьерам
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing delivery couriers report from {date_from_str} to {date_to_str}")
            
            # Call the API with basic parameters
            result = await self.api.reports_delivery_couriers_get(
                date_from=date_from_str,
                date_to=date_to_str
            )
            
            print(f"Delivery couriers report result type: {type(result)}")
            self.assertIsNotNone(result)
            
        except Exception as e:
            self.fail(f"Reports delivery couriers GET failed with error: {str(e)}")

    async def test_reports_delivery_order_cycle_get(self) -> None:
        """Test case for reports_delivery_order_cycle_get

        Цикл заказа
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing delivery order cycle report from {date_from_str} to {date_to_str}")
            
            # Call the API with basic parameters
            result = await self.api.reports_delivery_order_cycle_get(
                date_from=date_from_str,
                date_to=date_to_str,
            )
            
            print(f"Delivery order cycle report result type: {type(result)}")
            self.assertIsNotNone(result)
            
        except Exception as e:
            self.fail(f"Reports delivery order cycle GET failed with error: {str(e)}")

    async def test_reports_delivery_half_hour_detailed_get(self) -> None:
        """Test case for reports_delivery_half_hour_detailed_get

        Получасовой детальный отчет
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing delivery half hour detailed report from {date_from_str} to {date_to_str}")
            
            # Call the API with basic parameters
            result = await self.api.reports_delivery_half_hour_detailed_get(
                date_from=date_from_str,
                date_to=date_to_str
            )
            
            print(f"Delivery half hour detailed report result type: {type(result)}")
            self.assertIsNotNone(result)
        except Exception as e:
            self.fail(f"Reports delivery half hour detailed GET failed with error: {str(e)}")

    async def test_reports_delivery_regions_get(self) -> None:
        """Test case for reports_delivery_regions_get

        Отчет по регионам
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing delivery regions report from {date_from_str} to {date_to_str}")
            
            # Call the API with basic parameters
            result = await self.api.reports_delivery_regions_get(
                date_from=date_from_str,
                date_to=date_to_str
            )
            
            print(f"Delivery regions report result type: {type(result)}")
            self.assertIsNotNone(result)
            
        except Exception as e:
            self.fail(f"Reports delivery regions GET failed with error: {str(e)}")

    async def test_reports_delivery_loyalty_get(self) -> None:
        """Test case for reports_delivery_loyalty_get

        Отчет по лояльности
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing delivery loyalty report from {date_from_str} to {date_to_str}")
            
            # Test with AVERAGE metric type
            result_average = await self.api.reports_delivery_loyalty_get(
                date_from=date_from_str,
                date_to=date_to_str,
                metric_type=MetricTypeEnum.AVERAGE
            )
            
            print(f"Delivery loyalty report AVERAGE result type: {type(result_average)}")
            
        except Exception as e:
            self.fail(f"Reports delivery loyalty GET failed with error: {str(e)}")

    async def test_reports_olap_get(self) -> None:
        """Test case for reports_olap_get

        OLAP-отчет
        """
        try:
            # Calculate date range (last week)
            date_to = datetime.now()
            date_from = date_to - timedelta(days=7)
            
            # Format dates as DD.MM.YYYY
            date_from_str = date_from.strftime("%d.%m.%Y")
            date_to_str = date_to.strftime("%d.%m.%Y")
            
            print(f"Testing OLAP sales report from {date_from_str} to {date_to_str}")
            
            # Test SALES OLAP report with basic parameters
            result_sales = await self.api.reports_olap_get(
                report=OlapReportTypeEnum.SALES,
                var_from=date_from_str,
                to=date_to_str,
                summary=True,
                group_row=["RestorauntGroup"],
                agr=["DishSumInt"]
            )
            
            print(f"OLAP sales report result: {result_sales}")
            self.assertIsNotNone(result_sales)
            
            print(f"Testing OLAP transactions report from {date_from_str} to {date_to_str}")
            
            # Test TRANSACTIONS OLAP report
            result_transactions = await self.api.reports_olap_get(
                report=OlapReportTypeEnum.TRANSACTIONS,
                var_from=date_from_str,
                to=date_to_str,
                summary=False
            )
            
            print(f"OLAP transactions report result: {result_transactions}")
            self.assertIsNotNone(result_transactions)
            
            print(f"Testing OLAP deliveries report from {date_from_str} to {date_to_str}")
            
            # Test DELIVERIES OLAP report with grouping
            result_deliveries = await self.api.reports_olap_get(
                report=OlapReportTypeEnum.DELIVERIES,
                var_from=date_from_str,
                to=date_to_str,
                summary=True,
                group_row=["Delivery.ServiceType"],
                agr=["DishSumInt"]
            )
            
            print(f"OLAP deliveries report result type: {type(result_deliveries)}")
            self.assertIsNotNone(result_deliveries)
            
        except Exception as e:
            self.fail(f"Reports OLAP GET failed with error: {str(e)}")


if __name__ == '__main__':
    unittest.main()
