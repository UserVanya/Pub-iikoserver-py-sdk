# coding: utf-8

"""
    iikoServer API

    API Server позволяет сделать интеграции, которые предназначены для работы с номенклатурой, отчетами, документами, данными сотрудников и приказами.   ### Ограничения и рекомендации - Запросы должны выполняться последовательно друг за другом - Запрашивайте данные за период не длиннее одного месяца, в идеале — за один день или неделю - Для OLAPv2-отчетов рекомендуется устанавливать build-summary=false - При построении OLAPv2-отчета рекомендуется использовать не более 7 полей - Перед выполнением запросов проверяйте их на демо сервере

    The version of the OpenAPI document: 1.0.0
    Generated by OpenAPI Generator (https://openapi-generator.tech)

    Do not edit the class manually.
"""  # noqa: E501


from datetime import datetime, timedelta
import unittest
import os
import hashlib
import asyncio

from iikoserver_client.api.session_management_api import SessionManagementApi
from iikoserver_client.api.corporation_management_api import CorporationManagementApi
from iikoserver_client import ApiClient
from iikoserver_client.configuration import Configuration
from iikoserver_client.api.reports_v2_api import ReportsV2Api
from iikoserver_client.models.olap_v2_report_type_enum import OlapV2ReportTypeEnum
from iikoserver_client.models.olap_preset_type_enum import OlapPresetTypeEnum
from iikoserver_client.models.olap_v2_request import OlapV2Request
from iikoserver_client.models.olap_period_type_enum import OlapPeriodTypeEnum
from iikoserver_client.models.olap_filter import OlapFilter

class TestReportsV2Api(unittest.IsolatedAsyncioTestCase):
    """ReportsV2Api unit test stubs"""

    async def asyncSetUp(self) -> None:
        # Read credentials from env variables or set them directly
        self.server_url = os.environ.get("IIKO_SERVER_URL", None)
        self.login = os.environ.get("IIKO_SERVER_LOGIN", None)  # Replace with your login
        self.password = os.environ.get("IIKO_SERVER_PASSWORD", None)  # Replace with your password
        
        if not all([self.server_url, self.login, self.password]):
            self.skipTest("Missing environment variables: IIKO_SERVER_URL, IIKO_SERVER_LOGIN, IIKO_SERVER_PASSWORD")
        
        self.password_hash = hashlib.sha1(self.password.encode()).hexdigest()
        
        # Create configuration
        self.config = Configuration(host=self.server_url, debug=True)
        
        # Create API client with context manager support
        self.client = ApiClient(configuration=self.config)
        
        # Test data IDs - these should be updated with actual IDs from your test environment
        self.test_department_id = "a99e7f0c-0f19-467d-b845-f7052c81c7ed"
        self.test_store_id = "1239d270-1bbe-f64f-b7ea-5f00518ef508"
        self.test_product_id = "244079d3-3fa1-4479-96ef-e8183ed96de9"
        self.test_counteragent_id = "6a656dcc-9e1b-4a3a-90a8-01202184c93f"
        
        self.session_api = SessionManagementApi(api_client=self.client)
        self.corporation_api = CorporationManagementApi(api_client=self.client)
        await self.session_api.auth_post(login=self.login, var_pass=self.password_hash)
        self.api = ReportsV2Api(api_client=self.client)

    async def asyncTearDown(self) -> None:
        # Make sure to properly close all connections
        try:
            await self.session_api.logout_post()
        except Exception as e:
            print(f"Warning: logout failed: {e}")
        
        # Ensure client is closed properly
        await self.client.close()
        
        # Give event loop time to cleanup resources
        await asyncio.sleep(0.1)

    async def test_reports_balance_counteragents_get(self) -> None:
        """Test case for reports_balance_counteragents_get

        Балансы по счетам, контрагентам и подразделениям
        """
        try:
            # Use current timestamp
            timestamp = datetime.now()
            
            print(f"Testing counteragents balance report for timestamp {timestamp}")
            
            # Call the API with basic parameters
            result = await self.api.v2_reports_balance_counteragents_get(
                timestamp=timestamp
            )
            
            print(f"Counteragents balance report result type: {type(result)}")
            print(f"Counteragents balance report result length: {len(result) if result else 0}")
            self.assertIsNotNone(result)
        except Exception as e:
            self.fail(f"Reports balance counteragents GET failed with error: {str(e)}")

    async def test_reports_balance_stores_get(self) -> None:
        """Test case for reports_balance_stores_get

        Остатки на складах
        """
        try:
            # Use current timestamp
            timestamp = datetime.now()

            print(f"Testing store balance report for timestamp {timestamp}")
            
            # Call the API with basic parameters
            result = await self.api.v2_reports_balance_stores_get(
                timestamp=timestamp
            )
            
            print(f"Store balance report result type: {type(result)}")
            print(f"Store balance report result length: {len(result) if result else 0}")
            self.assertIsNotNone(result)
        except Exception as e:
            self.fail(f"Reports balance stores GET failed with error: {str(e)}")

    async def test_reports_egais_marks_list_get(self) -> None:
        """Test case for reports_egais_marks_list_get

        Отчет по балансу на 3 регистре ЕГАИС (акцизные марки)
        """
        try:
            print("Testing EGAIS marks list report")
            
            # Call the API with basic parameters
            result = await self.api.v2_reports_egais_marks_list_get()
            
            print(f"EGAIS marks list report result type: {type(result)}")
            self.assertIsNotNone(result)
            
            if hasattr(result, 'revision'):
                print(f"EGAIS marks report revision: {result.revision}")
            if hasattr(result, 'full_update'):
                print(f"EGAIS marks report full_update: {result.full_update}")
            
            # Test with revision filter
            result_with_revision = await self.api.v2_reports_egais_marks_list_get(
                revision_from=0
            )
            
            print(f"EGAIS marks list report with revision result type: {type(result_with_revision)}")
            self.assertIsNotNone(result_with_revision)
        except Exception as e:
            self.fail(f"Reports EGAIS marks list GET failed with error: {str(e)}")

    async def test_v2_reports_olap_columns_get(self):
        """Test OLAP V2 columns API"""
        try:
            print(f"Testing OLAP V2 columns report")
            
            # Call the API for SALES report type
            result = await self.api.v2_reports_olap_columns_get(
                report_type=OlapV2ReportTypeEnum.SALES
            )
            
            print(f"OLAP V2 columns result type: {type(result)}")
            self.assertIsNotNone(result)
            
            # Test TRANSACTIONS report type
            result_transactions = await self.api.v2_reports_olap_columns_get(
                report_type=OlapV2ReportTypeEnum.TRANSACTIONS
            )
            
            print(f"OLAP V2 columns (TRANSACTIONS) result type: {type(result_transactions)}")
            self.assertIsNotNone(result_transactions)
            
            # Test DELIVERIES report type
            result_deliveries = await self.api.v2_reports_olap_columns_get(
                report_type=OlapV2ReportTypeEnum.DELIVERIES
            )
            
            print(f"OLAP V2 columns (DELIVERIES) result type: {type(result_deliveries)}")
            self.assertIsNotNone(result_deliveries)
            
        except Exception as e:
            self.fail(f"Reports OLAP V2 columns GET failed with error: {str(e)}")

    async def test_v2_reports_olap_post(self):
        """Test OLAP V2 report API"""
        try:
            print(f"Testing OLAP V2 report")
            
            # Create date filter
            date_filter = OlapFilter(
                filter_type="DateRange",
                period_type=OlapPeriodTypeEnum.CUSTOM,
                var_from=(datetime.now() - timedelta(days=3)).date(),
                to=datetime.now().date()
            )
            # Create request for SALES report
            request = OlapV2Request(
                report_type=OlapV2ReportTypeEnum.SALES,
                build_summary=True,
                group_by_row_fields=["OpenDate.Typed"],
                aggregate_fields=["DishSumInt"],
                filters={
                    "OpenDate.Typed": date_filter
                }
            )
            
            # Call the API
            result = await self.api.v2_reports_olap_post(
                olap_v2_request=request
            )
            
            print(f"OLAP V2 report result: {result}")
            self.assertIsNotNone(result)
            
        except Exception as e:
            self.fail(f"Reports OLAP V2 POST failed with error: {str(e)}")

    async def test_v2_reports_olap_presets_get(self):
        """Test OLAP V2 presets list API"""
        try:
            print(f"Testing OLAP V2 presets list")
            
            # Call the API
            result = await self.api.v2_reports_olap_presets_get()
            
            print(f"OLAP V2 presets result type: {type(result)}")
            print(f"OLAP V2 presets result length: {len(result) if result else 0}")
            self.assertIsNotNone(result)
            
        except Exception as e:
            self.fail(f"Reports OLAP V2 presets GET failed with error: {str(e)}")

    async def test_v2_reports_olap_presets_preset_type_get(self):
        """Test OLAP V2 presets by type API"""
        try:
            print(f"Testing OLAP V2 presets by type")
            
            # Test sales presets
            result_sales = await self.api.v2_reports_olap_presets_preset_type_get(
                preset_type=OlapPresetTypeEnum.SALES
            )
            
            print(f"OLAP V2 presets (sales) result type: {type(result_sales)}")
            print(f"OLAP V2 presets (sales) result length: {len(result_sales) if result_sales else 0}")
            self.assertIsNotNone(result_sales)
            
            # Test transactions presets
            result_transactions = await self.api.v2_reports_olap_presets_preset_type_get(
                preset_type=OlapPresetTypeEnum.TRANSACTIONS
            )
            
            print(f"OLAP V2 presets (transactions) result type: {type(result_transactions)}")
            self.assertIsNotNone(result_transactions)
            
        except Exception as e:
            self.fail(f"Reports OLAP V2 presets by type GET failed with error: {str(e)}")

    async def test_v2_reports_olap_by_preset_id_get(self):
        """Test OLAP V2 report by preset ID API"""
        try:
            print(f"Testing OLAP V2 report by preset ID")
            
            # First get available presets
            presets = await self.api.v2_reports_olap_presets_get()
            
            if presets and len(presets) > 0:
                # Use first available preset
                preset_id = presets[0].id
                
                print(f"Testing with preset ID: {preset_id}")
                
                # Call the API with preset ID
                result = await self.api.v2_reports_olap_by_preset_id_preset_id_get(
                    preset_id=preset_id,
                    summary=True
                )
                
                print(f"OLAP V2 report by preset ID result type: {type(result)}")
                self.assertIsNotNone(result)
                
                # Test with date range
                from_date = (datetime.now() - timedelta(days=3)).date()
                to_date = datetime.now().date()
                
                result_with_dates = await self.api.v2_reports_olap_by_preset_id_preset_id_get(
                    preset_id=preset_id,
                    summary=False,
                    date_from=from_date,
                    date_to=to_date
                )
                
                print(f"OLAP V2 report by preset ID with dates result type: {type(result_with_dates)}")
                self.assertIsNotNone(result_with_dates)
                
            else:
                print("No presets available for testing")
                
        except Exception as e:
            self.fail(f"Reports OLAP V2 by preset ID GET failed with error: {str(e)}")


if __name__ == '__main__':
    unittest.main() 